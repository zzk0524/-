define("lesson/js/code",["lesson/js/common","lesson/js/term","lesson/js/verify-code","ace"],function(e,t,i){function s(t){this.termID="codeterm",this.termBox="term-content",this.termTimer=null;var i=this.termgrid();if(this.cols=i.cols,this.rows=i.rows,"https:"==document.location.protocol)var s="wss://clide.imooc.com";else var s="ws://clide.imooc.com";var n={api:s,path:t+"/socket.io",transports:["websocket"]};window.WebSocket||(n.transports=["polling"]);var o=this;require(["socketio"],function(e){o.socketIO=e,o.init(n)}),e.on("lesson.resize",function(){o.resize()})}function n(e){this.APIs={commit:"//program.imooc.com/api/run",saveURI:"//program.imooc.com/api/savecode",oldcommit:"/lesson/codesubmit"},this.preCompileURI="/lesson/ajaxprecompile?file=",this.init(e)}return s.prototype={init:function(e){var i=this,s=!1,n=new t({cols:this.cols,rows:this.rows,useStyle:!0,screenKeys:!0,cursorBlink:!1});n.on("data",function(e){i.socket.emit("term.input",{id:i.termID,input:e})}),n.open(document.getElementById(i.termBox)),i.term=n,i.connect();var o=i.socketIO(e.api,{transports:e.transports,path:"/"+e.path,reconnection:!0,"force new connection":!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:8,timeout:5e3});o.on("connect",function(){o.emit("term.open",{id:i.termID,col:i.cols,row:i.rows}),s=!0,i.connected()}),o.on("term.output",function(e,t){i.term&&i.term.write(t)}),o.on("connect_error",function(){s&&(s=!1,n.write("connection error\r\n"),i.connect(),$(".js-run").addClass("disabled"))}),o.on("reconnect_failed",function(){i.failed()}),i.socket=o},termgrid:function(){var e=$("#"+this.termBox),t=e.width(),i=e.height();0==$(".xterm-char-measure-element").length&&e.append('<div class="terminal" style="position: absolute;top:0"><div class="xterm-char-measure-element">W</div></div>');var s=8;return $(".xterm-char-measure-element").get(0)&&$(".xterm-char-measure-element").get(0).getBoundingClientRect&&(s=$(".xterm-char-measure-element").get(0).getBoundingClientRect().width),{cols:Math.floor((t-20)/s),rows:Math.floor(i/17)}},connect:function(){var e=this;clearInterval(this.termTimer),this.termTimer=null,this.term.write("connection to service"),this.termTimer=setInterval(function(){e.term.write(".")},1e3)},connected:function(){clearInterval(this.termTimer),this.termTimer=null,this.term.write("\r\nconnection succeed\r\n"),$(".js-run").removeClass("disabled")},failed:function(){clearInterval(this.termTimer),this.termTimer=null,this.term.write("\r\nconnection failed, please refresh the page!\r\n")},command:function(e){this.socket.emit("term.input",{id:this.termID,input:e+"\n"})},write:function(e){this.term.write(e+"\r\n")},resize:function(){var e=this.termgrid();this.term&&this.term.resize(e.cols,e.rows),""!=this.socket&&this.socket.emit("term.resize",e)},destroy:function(){this.socket&&this.socket.io.disconnect()}},n.prototype={init:function(t){setTimeout(function(){$(".js-term-tip").hide(100)},6e4);var i=this;this.mid=OP_CONFIG.mid,this.files=[],this.lastFile=null,this.fileurl="",this.editors=[],this.mainLang="",this.activeTimer=null,this.termService&&this.termService.destroy(),OP_CONFIG.ssh?(this.termService=new s(OP_CONFIG.ssh),OP_CONFIG.ssh=""):this.frameinit(),this.canCommit=!0,e.tabSlider.create("#codeTab",{menu:".files-menu li",block:".files-block"}),t.each(function(){var e=$(this).data("filename"),t=i.getLang(e);i.mainLang||(i.mainLang=$(this).data("lang"));var s=$(this).data("lang");"js"==t&&(t="javascript"),"m"==t&&(t="objectivec");var n=ace.edit(this);n.setTheme("ace/theme/twilight"),n.setFontSize("14px"),n.session.setMode("ace/mode/"+t),n.setHighlightActiveLine(!1),n.session.setUseWrapMode(!0),n.session.setWrapLimitRange(null,null),n.renderer.setShowPrintMargin(!1),n.filename=e,i.editors.push(n);var o={filename:e,lang:s,_lang:t,content:n.getValue()};i.files.push(o),n.on("change",function(){o.content=n.getValue(),i.lastFile=o,("html"!=i.files[0]._lang&&"javascript"!=i.files[0]._lang||$("#aotoruncheck")[0].checked)&&(i.termService?i.activeCheck():("html"==t||"javascript"==t||"js"==t)&&i.runCode(t))}),$(document).on("change","#aotoruncheck",function(){$(this)[0].checked?$(this).closest(".aotorun").find(".checkIcon").removeClass("imv2-checkbox_onk").addClass("imv2-checkbox"):$(this).closest(".aotorun").find(".checkIcon").removeClass("imv2-checkbox").addClass("imv2-checkbox_onk")})}),i.termService||("html"==i.files[0]._lang||"javascript"==i.files[0]._lang?$("#codeBtn .aotorun").show():$("#codeBtn .aotorun").hide())},activeCheck:function(){var e=this;clearTimeout(this.activeTimer),this.activeTimer=null,this.activeTimer=setTimeout(function(){$.get("/lesson/ajaxupadteaccesstime?lang="+e.mainLang)},3e4)},frameinit:function(){var e=window.frames.Consoleframe;this.iframedocument=e.document?e.document:e.contentDocument},getFiles:function(){return this.files},getLang:function(e){return e.substr(e.lastIndexOf(".")+1)},runCode:function(e,t){var i,s="<\\s*link[^>]*?href=(['\"])\\s*",n="\\s*\\1[^>]*?>",o="<\\s*script[^>]*?src=(['\"])\\s*",r="\\s*\\1[\\s\\S]*?<\\/script>";"html"==e?$.each(this.files,function(e,t){t.lang=t._lang.toLowerCase(),"html"==t.lang?i=t.content:"css"==t.lang?(regstyle=new RegExp(s+t.filename+n),regstyle.test(i)&&(i=i.replace(regstyle,"<style>"+t.content+"</style>"))):"javascript"==t.lang&&(regscript=new RegExp(o+t.filename+r),regscript.test(i)&&(i=i.replace(regscript,"<script>"+t.content+"</script>")))}):"javascript"==e?(i="",$.each(this.files,function(e,t){i+="<script>"+t.content+"</script>"})):i=t.runResult,this.iframedocument.open(),this.iframedocument.write(i),this.iframedocument.close()},commit:function(t){var s=this;if(this.canCommit){this.canCommit=!1;{this.getFiles().length}codeParams.commitfile=this.getFiles(),codeParams.uid=OP_CONFIG.userInfo.uid,""!=t&&"undefined"!=typeof t&&(codeParams.verifyCode=t),$.ajax({url:this.APIs.commit,type:"POST",dataType:"json",data:codeParams,xhrFields:{withCredentials:"true"},success:function(t){var n=codeParams.lang.toLowerCase();s.saveCode({mid:OP_CONFIG.mid,lang:codeParams.lang,files:codeParams.commitfile,key:t.data.key}),200==t.data.result?(e.emit("lesson.finish"),$(".js-block").hide(),$(".js-verify-code-box").hide(),e.emit("code.checked",{type:"success"})):429==t.data.result?($(".js-block").height($(document).height()).show(),$(".js-verify-code-box").show(),i.renderVerifyCodeBlock(".js-verify-code-box .verify-code","//program.imooc.com/api/verifycode")):430==t.data.result?($(".js-verify-code-box").find(".js-verify-code-tip").html("验证码错误，请重试。").show(),$(".js-verify-code-box .verify-code").find(".verify-code-ipt").val(""),$(".js-verify-code-box").find(".js-verify-refresh").click()):e.emit("code.checked",{type:"error",msg:t.data.msg||t.message||"运行失败"}),$("#J_VC_Commit").removeClass("submiting").val("提交"),$(".js-verify-code-box .js-verify-code-tip").hide(),t.data.runResult&&t.data.runResult.length>0&&s.runCode(n,t.data),s.canCommit=!0},error:function(e){$("#J_VC_Commit").removeClass("submiting").val("提交"),$(".js-verify-code-box .js-verify-code-tip").hide(),$(".js-block").hide(),$(".js-verify-code-box").hide(),s.canCommit=!0}})}},oldcommit:function(){var t=this,i={};i.mid=t.mid,i.cid=OP_CONFIG.curCourse.id,i.lang=t.mainLang,i.files=t.files,i.fileurl=t.fileurl,$.ajax({type:"POST",url:t.APIs.oldcommit,data:i,dataType:"JSON",success:function(t){0==t.result?(e.emit("lesson.finish"),e.emit("code.checked",{type:"success"})):e.emit("code.checked",{type:"error",msg:t.msg})}})},saveCode:function(e){var t=this;if(!this.termService)return $.post("/lesson/savecodent",e,function(){},"json"),!1;var i={};i.cid=OP_CONFIG.curCourse.id,i.lang=codeParams.lang,i.files=t.files,i.sid=t.mid+"-"+OP_CONFIG.userInfo.uid,$.post(t.APIs.saveURI,i,function(e){0==e.code?(t.termService.write(e.message),t.termService.command(e.command)):-1==e.code&&t.termService.write(e.message)},"json")},resetCode:function(e){var t=this;t.termService&&(e=function(){}),$.ajax({type:"GET",url:"/lesson/resetcode",data:{mid:t.mid},dataType:"json",success:function(i){if(0==i.result){for(var s={},n=i.data.length;n--;)s[i.data[n].filename]=i.data[n];$.each(t.editors,function(e,t){s[t.filename]&&t.setValue(s[t.filename].content)}),e&&e()}}})},screenCode:function(){var e=$("#viewPort-content");e.hasClass("screen")?e.removeClass("screen"):e.addClass("screen")},preCompile:function(e){var t=this;t.activeCheck(),t.termService.write("code compiling"),$.ajax({type:"GET",url:t.preCompileURI+e.file,dataType:"json",success:function(e){0==e.result?t.termService.command(e.cmd):t.termService.write(e.msg)},error:function(){t.termService.write("code compile error, please try again!")},complete:function(){$(".js-run").removeClass("disabled")}})}},{create:function(e){return new n(e)}}});